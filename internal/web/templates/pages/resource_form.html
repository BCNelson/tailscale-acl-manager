{{define "content"}}
{{- $data := . -}}
{{- $stackID := $data.StackID -}}
{{- $meta := $data.Resource -}}
{{- $item := $data.Item -}}
{{- $isEdit := $data.IsEdit -}}

<form
  {{if $isEdit}}
  {{$idField := $meta.IDField}}
  {{$id := ""}}
  {{if eq $idField "name"}}
    {{$id = index $item "name"}}
  {{else if eq $idField "tag"}}
    {{$id = index $item "tag"}}
  {{else}}
    {{$id = index $item "id"}}
  {{end}}
  hx-put="/stacks/{{$stackID}}/{{$meta.Name}}/{{$id}}"
  {{else}}
  hx-post="/stacks/{{$stackID}}/{{$meta.Name}}"
  {{end}}
  hx-swap="none"
>
  {{if $meta.HasOrder}}
  <div class="form-group">
    <label for="order">Order</label>
    <input type="number" id="order" name="order" value="{{if $item}}{{index $item "order"}}{{else}}0{{end}}" min="0">
    <div class="help-text">Lower numbers are processed first within this stack</div>
  </div>
  {{end}}

  {{range $meta.Fields}}
  {{$value := ""}}
  {{if $item}}
    {{$rawValue := index $item .Name}}
    {{if $rawValue}}
      {{if eq (printf "%T" $rawValue) "[]string"}}
        {{$value = join $rawValue "\n"}}
      {{else}}
        {{$value = $rawValue}}
      {{end}}
    {{end}}
  {{end}}

  {{if and $isEdit (or (eq .Name "name") (eq .Name "tag"))}}
    {{/* Show as read-only for edit since it's the ID field */}}
    <div class="form-group">
      <label for="{{.Name}}">{{.Label}}{{if .Required}} *{{end}}</label>
      <input type="text" id="{{.Name}}" name="{{.Name}}" value="{{$value}}" readonly style="background-color: var(--color-bg); cursor: not-allowed;">
      <div class="help-text">Cannot be changed after creation</div>
    </div>
  {{else}}
    <div class="form-group">
      <label for="{{.Name}}">{{.Label}}{{if .Required}} *{{end}}</label>
      {{if eq .Type "text"}}
      <input type="text" id="{{.Name}}" name="{{.Name}}" value="{{$value}}" {{if .Required}}required{{end}} {{if .Placeholder}}placeholder="{{.Placeholder}}"{{end}} {{if .ValidationPattern}}pattern="{{.ValidationPattern | safeHTMLAttr}}"{{end}} {{if .ValidationMessage}}title="{{.ValidationMessage}}"{{end}}>
      {{else if eq .Type "number"}}
      <input type="number" id="{{.Name}}" name="{{.Name}}" value="{{$value}}" {{if .Required}}required{{end}} {{if .Placeholder}}placeholder="{{.Placeholder}}"{{end}}>
      {{else if eq .Type "textarea"}}
      <textarea id="{{.Name}}" name="{{.Name}}" {{if .Required}}required{{end}} {{if .Placeholder}}placeholder="{{.Placeholder}}"{{end}} rows="4">{{$value}}</textarea>
      {{else if eq .Type "select"}}
      <select id="{{.Name}}" name="{{.Name}}" {{if .Required}}required{{end}}>
        {{range .Options}}
        <option value="{{.Value}}" {{if eq .Value $value}}selected{{end}}>{{.Label}}</option>
        {{end}}
      </select>
      {{end}}
      {{if .Help}}
      <div class="help-text">{{.Help}}</div>
      {{end}}
    </div>
  {{end}}
  {{end}}

  <div class="modal-footer" style="margin: 1rem -1.25rem -1.25rem; padding: 1rem 1.25rem; border-top: 1px solid var(--color-border);">
    <button type="button" class="btn btn-secondary" onclick="closeModal('modal')">Cancel</button>
    <button type="submit" class="btn btn-primary">
      <span class="htmx-indicator spinner"></span>
      {{if $isEdit}}Update{{else}}Create{{end}} {{$meta.Singular}}
    </button>
  </div>
</form>
{{end}}
